name: Debug NPM Token

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  debug:
    name: Debug NPM Authentication
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: Check if NPM_TOKEN is set
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "🔍 Checking NPM_TOKEN environment variable..."
          if [ -z "$NPM_TOKEN" ]; then
            echo "❌ NPM_TOKEN is NOT set or is empty"
            exit 1
          else
            echo "✅ NPM_TOKEN is set"
            echo "Token length: ${#NPM_TOKEN} characters"
            
            # Check if token starts with npm_
            if [[ $NPM_TOKEN == npm_* ]]; then
              echo "✅ Token starts with 'npm_' (correct format)"
            else
              echo "❌ Token doesn't start with 'npm_' (incorrect format)"
            fi
          fi

      - name: Test npm whoami (Method 1 - Direct .npmrc)
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "🧪 Test 1: Using .npmrc file..."
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          npm whoami || echo "❌ Failed with .npmrc method"
          rm ~/.npmrc

      - name: Test npm whoami (Method 2 - Environment variable)
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "🧪 Test 2: Using NODE_AUTH_TOKEN..."
          echo "//registry.npmjs.org/:_authToken=\${NODE_AUTH_TOKEN}" > ~/.npmrc
          NODE_AUTH_TOKEN="${NPM_TOKEN}" npm whoami || echo "❌ Failed with NODE_AUTH_TOKEN method"
          rm ~/.npmrc

      - name: Test npm whoami (Method 3 - setup-node integration)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "🧪 Test 3: Using setup-node with NODE_AUTH_TOKEN..."
          npm whoami || echo "❌ Failed with setup-node method"

      - name: Check npm config
        run: |
          echo "🔍 Current npm configuration:"
          npm config list
          echo ""
          echo "🔍 Registry:"
          npm config get registry

      - name: Test npm ping
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "🧪 Testing registry connectivity..."
          npm ping || echo "❌ Cannot ping registry"

      - name: Summary
        run: |
          echo ""
          echo "=================================="
          echo "🏁 Debug Summary"
          echo "=================================="
          echo ""
          echo "If all tests passed:"
          echo "  ✅ Your NPM_TOKEN secret is correctly configured"
          echo "  ✅ Use NODE_AUTH_TOKEN in your release workflow"
          echo ""
          echo "If tests failed:"
          echo "  1. Re-create the NPM_TOKEN secret in GitHub"
          echo "  2. Make sure no extra spaces/quotes when pasting"
          echo "  3. Verify it's an Automation token from npm"
          echo "  4. Check 2FA is set to 'Authorization only'"

